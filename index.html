<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>N.R.T. — Record an Achievement</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#4f46e5;--primary-2:#4338ca;--accent:#f59e0b;--danger:#ef4444;--ok:#10b981;--chip:#eef2ff;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 12px 28px rgba(20,20,40,.06);border:1px solid #e5e7eb}
  .titlebar{padding:18px 20px;border-bottom:1px solid #e5e7eb}
  h1{font-size:22px;margin:0} .muted{color:var(--muted);font-size:12px;margin-top:2px}
  .section{padding:18px 20px}
  .grid{display:grid;gap:12px} .g2{grid-template-columns:1fr 1fr} .g3{grid-template-columns:1fr 1fr 1fr}
  label{font-weight:650;font-size:12px;margin-bottom:6px;display:block}
  input[type="text"],input[type="number"],input[type="date"]{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;outline:none}
  input[readonly]{background:#f9fafb;color:#6b7280}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:650;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.primary:hover{background:var(--primary-2)}
  .btn.ghost{background:var(--chip);color:#3730a3}
  .btn.warn{background:var(--accent);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.gray{background:#e5e7eb}
  .footer{padding:14px 20px;border-top:1px solid #e5e7eb;display:flex;gap:12px;position:sticky;bottom:0;background:var(--card);z-index:100;box-shadow:0 -6px 16px rgba(20,20,40,.06);padding-bottom:calc(14px + env(safe-area-inset-bottom));}
  .spacer{flex:1}
  .chip{display:inline-flex;align-items:center;background:var(--chip);padding:6px 10px;border-radius:999px;gap:8px;font-size:12px}
  .combo{position:relative}
  .dropdown{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px;max-height:220px;overflow:auto;z-index:30;box-shadow:0 10px 24px rgba(20,20,40,.08)}
  .dd-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f3f4f6}
  .dd-item:last-child{border-bottom:0}
  .dd-item:hover{background:#f3f4f6}
  .qty{display:inline-flex;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px}
  .qty input{width:56px;border:0;background:transparent;text-align:center;padding:10px;appearance:textfield}
  .qty input::-webkit-outer-spin-button,.qty input::-webkit-inner-spin-button{appearance:none;margin:0}
  .qty button{border:0;background:transparent;padding:8px 10px;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:12px;text-align:left;color:#6b7280;font-weight:700;padding:0 8px}
  td{background:#fff;border:1px solid #e5e7eb;padding:8px;border-radius:10px;vertical-align:middle}
  td > input, td > .qty, td > .combo input{width:100%}
  td > .qty{justify-content:center;}
  .right{text-align:right}
  .manage{background:#fafafa;border-top:1px dashed #e5e7eb}
  .pill{font-size:11px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;background:#fff;cursor:pointer}
  .mini-pencil{position:absolute; right:6px; top:6px; border:1px solid #e5e7eb; border-radius:999px; padding:2px 6px; font-size:12px; background:#fff; cursor:pointer; line-height:1}
  .combo{position:relative}
  @media (min-width: 769px){
    .mini-pencil{display:none}
  }

  .list{display:grid;gap:8px}
  .list .rowitem{display:grid;grid-template-columns:1fr 180px 1fr auto auto;gap:8px;align-items:center}
  .rowitem input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;width:100%}
  .hidden{display:none}
  .saved-card{display:flex;gap:10px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .saved-card .meta{font-size:12px;color:#6b7280}
  .icon-btn{background:transparent;border:0;cursor:pointer;color:#6b7280}
  .icon{width:16px;height:16px;display:inline-block}
  @media (max-width:820px){ .g2,.g3{grid-template-columns:1fr} .list .rowitem{grid-template-columns:1fr} .footer{flex-direction:column} }

/* === Modern UI refresh (mobile-first, iOS/Android friendly) === */
:root{
  --bg:#f7f8fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --primary:#4f46e5;
  --primary-2:#4338ca;
  --ring:#a5b4fc;
  --danger:#ef4444;
  --accent:#f59e0b;
}
html,body{font-size:16px;}
body{background:radial-gradient(1200px 800px at 10% -10%, #f1f5ff 0%, #f7f8fb 40%, #f7f8fb 100%) fixed;}
.wrap{max-width:1100px;margin:28px auto;padding:0 16px;}

/* Inputs */
input[type="text"],input[type="number"],input[type="date"]{
  border-radius:12px;
  min-height:44px;
  border:1px solid #e2e8f0;
  transition:box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
  box-shadow:0 1px 2px rgba(15,23,42,.04);
}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus{
  border-color:var(--ring);
  box-shadow:0 0 0 4px rgba(165,180,252,.25);
}


/* Mobile layout for expanded contact row: 3 input lines, actions on 4th */
@media (max-width: 820px){
  #manageContacts .rowitem.is-expanded{
    display:grid !important;
    grid-template-columns: 1fr 1fr !important;
    grid-auto-rows: auto;
    gap: 8px !important;
    align-items: start;
  }
  #manageContacts .rowitem.is-expanded > input{
    grid-column: 1 / -1 !important; /* each input takes its own row */
  }
  #manageContacts .rowitem.is-expanded .save,
  #manageContacts .rowitem.is-expanded .del{
    display: none !important;
    grid-column: span 1 !important;
    justify-content: center;
  }
  #manageContacts .rowitem.is-expanded:focus-within .save,
  #manageContacts .rowitem.is-expanded:focus-within .del{
    display: inline-flex !important;
  }
}


/* Force Due & Grand wrappers to full width on small screens */
@media (max-width: 820px){
  .row div:has(> #due),
  .row div:has(> #grand){
    min-width:100% !important;
    width:100% !important;
    flex-basis:100% !important;
  }
}


/* Make two-column grids single-column on small screens (Date + Invoice) */
@media (max-width: 820px){
  .grid.g2{ grid-template-columns: 1fr !important; }
}


/* Mobile layout for expanded contact row: 3 input lines, actions on 4th; show actions only while editing */
@media (max-width: 820px){
  #manageContacts .rowitem.is-expanded{
    display:grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap:8px !important;
    align-items:start;
  }
  #manageContacts .rowitem.is-expanded > input{ grid-column:1 / -1 !important; }
  #manageContacts .rowitem.is-expanded .save,
  #manageContacts .rowitem.is-expanded .del{ display:none !important; grid-column:span 1; justify-content:center; }
  #manageContacts .rowitem.is-expanded:focus-within .save,
  #manageContacts .rowitem.is-expanded:focus-within .del{ display:inline-flex !important; }
}


/* Make two-column grids single-column on small screens (Date + Invoice full width) */
@media (max-width: 820px){
  .grid.g2{ grid-template-columns: 1fr !important; }
}

/* Buttons */
.btn{border-radius:12px;padding:12px 16px;font-weight:700;min-height:44px;transition:transform .06s ease, box-shadow .15s ease, background-color .15s ease;}
.btn:active{transform:translateY(1px);}
.btn.primary{
  background:linear-gradient(180deg, var(--primary) 0%, var(--primary-2) 100%);
  box-shadow:0 8px 16px rgba(79,70,229,.18);
}
.btn.primary:hover{filter:brightness(1.02);}
.btn.ghost{background:#eef2ff;color:#3730a3;}
.btn.warn{background:#f59e0b;color:#fff;box-shadow:0 8px 16px rgba(245,158,11,.18)}
.btn.danger{background:#ef4444;color:#fff;box-shadow:0 8px 16px rgba(239,68,68,.18)}

/* Card + title */
.card{border-radius:20px;box-shadow:0 20px 40px rgba(2,6,23,.06);border:1px solid #e2e8f0;}
.titlebar h1{font-size:24px}
.muted{color:var(--muted)}

/* Table */
table{border-collapse:separate;border-spacing:0 10px;}
td{background:#fff;border-top-left-radius:12px;border-bottom-left-radius:12px}

/* Sticky actions */
.footer{position:sticky;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(255,255,255,.86), #fff);backdrop-filter:blur(8px);border-top:1px solid #e2e8f0;padding:14px 16px;gap:12px}
@supports(padding: max(0px)){
  .footer{padding-bottom:calc(14px + env(safe-area-inset-bottom))}
}

/* Dropdowns */
.dropdown{border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 12px 24px rgba(2,6,23,.08)}
.dd-item{padding:10px 12px;font-size:14px;border-bottom:1px solid #f1f5f9}
.dd-item:hover{background:#f8fafc}

/* Chips / toggles */
.chip{background:#f1f5ff;color:#3730a3}

/* Responsive */
@media (max-width: 768px){
  .g2,.g3{grid-template-columns:1fr !important}
  .footer{flex-direction:column}
}

/* === Modal popups for Manage sections (overlay, no scrolling to bottom) === */
.manage {
  position: fixed;
  top: 6vh;
  left: 50%;
  transform: translateX(-50%);
  width: min(980px, calc(100vw - 40px));
  max-height: 88vh;
  overflow: auto;
  background: var(--card);
  border: 1px solid #e5e7eb;
  box-shadow: 0 24px 60px rgba(20,20,40,.18);
  border-radius: 16px;
  z-index: 1000;
  padding: 16px;
}
.manage.hidden{ display:none; } /* keep hidden behavior */
body.has-modal{ overflow:hidden; } /* lock body scroll when modal open */
/* When types & models are shown together, make them tidy columns */
#manageCatalog .grid.g2{ grid-template-columns: 1fr 1fr; gap: 16px; }
#manageCatalog .section{ background:transparent; border:0; padding:0; }
#manageCatalog #closeManageTypes, 
#manageCatalog #closeManageModels{ display:none; } /* one close button at top */

/* Ensure the Manage Product Types & Models popup is tall enough on larger screens */
@media (min-width: 768px){
  #manageCatalog .list{ min-height: 300px; } /* ~5+ rows visible */
}
</style>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
  <meta name="theme-color" content="#ffffff">
<style id="nrt-design-overrides">

/* === N.R.T. Design Overrides (Design-only) ===================================
   - Make all inputs consistent (incl. readonly: invoice, number, address, grand)
   - Make product row (qty/price/total) less bulky but finger-friendly
   - Keep system dark-mode support
============================================================================= */
/* === Center text vertically in embedded Add buttons ======================== */
#mtAdd, #mmAdd, #csTypeAdd{
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  line-height: 1 !important;
  gap: 4px;
}
/* Remove transform from active press that breaks centering */
#mtAdd:active, #mmAdd:active, #csTypeAdd:active{
  transform: scale(0.98);
}
/* ========================================================================= */

/* === Polished style for embedded Add buttons =============================== */
#mtAdd, #mmAdd, #csTypeAdd{
  height: 34px !important;
  padding: 0 14px !important;
  border-radius: 999px !important;
  font-size: 0.92rem !important;
  font-weight: 600 !important;
  background: #ffffff !important;
  color: #4f46e5 !important; /* keep brand-ish purple tone */
  border: 1px solid rgba(79,70,229,.35) !important;
  transition: all .18s ease-in-out !important;
}

#mtAdd::before, #mmAdd::before, #csTypeAdd::before{
  content: "+"; 
  display: inline-block;
  font-weight: 700;
  margin-right: 6px;
  transform: translateY(-1px);
}

/* Hover / focus states */
#mtAdd:hover, #mmAdd:hover, #csTypeAdd:hover,
#mtAdd:focus, #mmAdd:focus, #csTypeAdd:focus{
  background: #4f46e5 !important;
  color: #ffffff !important;
  border-color: #4f46e5 !important;
  box-shadow: 0 10px 24px rgba(79,70,229,.28) !important;
}

/* Active press */
#mtAdd:active, #mmAdd:active, #csTypeAdd:active{
  transform: translateY(-50%) scale(0.98);
}
/* ========================================================================== */

/* === Integrate “Add” buttons inside search fields (stronger selectors) === */
/* Make the rows that contain the search inputs positioning contexts */
.row:has(#mtSearch),
.row:has(#mmSearch),
.row:has(#csSearch){
  position: relative !important;
}

/* Give room inside inputs for the button chip */
#mtSearch, #mmSearch, #csSearch{
  padding-right: 96px !important;
}

/* Place the Add buttons inside the right end of those inputs */
#mtAdd, #mmAdd, #csTypeAdd{
  position: absolute !important;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  height: 36px;
  padding: 0 16px;
  border-radius: 999px;
  box-shadow: 0 8px 18px rgba(59,130,246,.18);
  z-index: 3;
}
/* ======================================================================== */


:root{
  --inp-h: 50px;
  --inp-r: 12px;
  --inp-b: 1.5px;
  --border: #e5e7eb;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --accent: #3b82f6;
  --ring: rgba(59,130,246,.25);
  --soft: #f8fafc;
}

/* Dark mode tokens */
@media (prefers-color-scheme: dark){
  :root{
    /* Keep light UI even in dark mode (design-only) */
    --border: #d1d5db;
    --surface: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --soft: #f8fafc;
    --ring: rgba(165,180,252,.35);
  }
}


/* Global input look */
body .wrap input[type="text"],
body .wrap input[type="number"],
body .wrap input[type="date"],
body .wrap select,
.section table td input {
  min-height: var(--inp-h) !important;
  font-size: 16px !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  box-shadow: none !important;
}

/* Readonly fields should look like normal inputs */
#invoice, #contactPhone, #contactAddress, #grand, #savedSearch,
body .wrap input[readonly]{
  background: var(--surface) !important;
  color: var(--text) !important;
  opacity: 1 !important;
  min-height: var(--inp-h) !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
}

/* Search inputs consistent */
/* Make Name/Number/Address boxes use the full available width */
#contactSearch,
#contactPhone,
#contactAddress{
  width: 100% !important;
}

#contactSearch{ min-height: var(--inp-h) !important; }

/* Product row — slimmer */
.section table tbody td{ padding-top: 8px !important; padding-bottom: 8px !important; }

/* Quantity group: compact but usable */
.qty{
  display:inline-flex; align-items:center; gap:8px;
  padding: 4px 6px !important;
  border: var(--inp-b) solid var(--border) !important;
  border-radius: 999px !important;
  background: var(--surface) !important;
}
.qty .qtyInput{
  width: 90px !important; height: 32px !important;
  border:0 !important; background:transparent !important;
  text-align:center !important; font-size:16px !important; padding:0 !important;
}
.qty .inc, .qty .dec{
  width: 28px !important; height: 28px !important; line-height: 24px !important;
  border-radius: 999px !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--soft) !important; font-size:18px !important; padding:0 !important;
  display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
}

/* Numeric fields align right */
.priceInput, .lineTotal, #due{ text-align:right !important; font-variant-numeric: tabular-nums; }
.priceInput, .lineTotal{ min-width: 120px !important; }
#due{ min-width: 180px !important; }

/* Focus ring */
body .wrap input[type="text"]:focus,
body .wrap input[type="number"]:focus,
body .wrap input[type="date"]:focus,
body .wrap select:focus {
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 3px var(--ring) !important;
  outline: none !important;
}


/* === Mobile responsiveness for items table (design-only) === */
@media (max-width: 640px){
  /* Collapse table into cards to avoid horizontal scroll */
  .section table thead{ display:none !important; }
  .section table, .section table tbody, .section table tr, .section table td{ display:block !important; width:100% !important; }
  .section table tbody tr{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:10px; }
  .section table tbody td{ border:0 !important; padding:6px 0 !important; background:transparent !important; }
  .section table tbody td.right{ text-align:left !important; }
  /* Inputs use full width on mobile */
  .priceInput, .lineTotal, #due{ min-width:0 !important; width:100% !important; }
  /* Quantity control smaller */
  .qty .qtyInput{ width:160px !important; }
}

/* Simplified popup: make inputs match main form boxes */
#catalogSimple input { 
  min-height: var(--inp-h) !important;
  font-size: 16px !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  width: 100%;
}
#catalogSimple .row { align-items: center; }
#catalogSimple #csTypeActions { justify-content: flex-end; }

/* === Tweaks per user request === */
/* Bigger manage popup */
.manage#catalogSimple{ width:min(840px, 90vw); }
.manage#catalogSimple .dd{ max-height:320px !important; } /* show ~5+ items */

/* Inputs in manage popup styled like Due/Number boxes */
#catalogSimple input{ 
  min-height: var(--inp-h) !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  width: 100%;
}

/* Manage Contacts inputs look like 'Due' box */
#manageContacts input{
  min-height: var(--inp-h);
  padding: 10px 12px;
  border-radius: var(--inp-r);
  border: var(--inp-b) solid var(--border);
  background: var(--surface);
  color: var(--text);
}

/* === Fix: Model input collapsing + long Save button ======================= */
/* Apply only to model lists in both popups */
#csModelsList .rowitem, #mmList .rowitem{
  display: grid !important;
  grid-template-columns: minmax(140px,1fr) auto auto !important;
  align-items: center !important;
  gap: 8px !important;
}
/* Hide the two placeholder spans used in original 5-col grid */
#csModelsList .rowitem span, #mmList .rowitem span{ display:none !important; }
/* Ensure the text input uses the full first column and doesn't shrink weirdly */
#csModelsList .rowitem input, #mmList .rowitem input{
  width: 100% !important;
  min-width: 0 !important;
  box-sizing: border-box !important;
}

/* Make Save/Delete compact pills and prevent stretching */
#csModelsList .rowitem .save, #mmList .rowitem .save,
#csModelsList .rowitem .del,  #mmList .rowitem .del{
  width: auto !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 8px 14px !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
  white-space: nowrap !important;
}

/* === Manage Contacts fixes (mobile + desktop) ============================= */
/* 1–4: Balanced inputs + consistent pill buttons */
#manageContacts .rowitem{
  display: grid !important;
  grid-template-columns: 1.2fr 1fr 1.2fr auto auto !important; /* Name | Phone | Address | Save | Delete */
  align-items: center !important;
  gap: 8px !important;
}

/* Inputs take full space of their columns and don't collapse */
#manageContacts .rowitem input{
  width: 100% !important;
  min-width: 0 !important;
  box-sizing: border-box !important;
}

/* Buttons: compact pill, equal sizing */
#manageContacts .rowitem .save,
#manageContacts .rowitem .del{
  padding: 10px 16px !important;
  min-width: 90px !important;
  height: 40px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  white-space: nowrap !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
}

/* 5: Show Save/Delete only when editing (focus within row) */
#manageContacts .rowitem .save,
#manageContacts .rowitem .del{ display: none !important; }
#manageContacts .rowitem:focus-within .save,
#manageContacts .rowitem:focus-within .del{ display: inline-flex !important; }

/* Mobile: keep the three inputs readable; buttons still inline */
@media (max-width: 640px){
  #manageContacts .rowitem{ grid-template-columns: 1.1fr 1fr 1.1fr auto auto !important; } 
  #manageContacts .rowitem .save,
  #manageContacts .rowitem .del{ min-width: 84px !important; height: 38px !important; padding: 8px 14px !important; }
}

/* === Show Save/Delete only when row is focused (Types + Models) ========== */
#mtList .rowitem .save, #mtList .rowitem .del,
#mmList .rowitem .save, #mmList .rowitem .del,
#csModelsList .rowitem .save, #csModelsList .rowitem .del{
  display: none !important;
}
#mtList .rowitem:focus-within .save, #mtList .rowitem:focus-within .del,
#mmList .rowitem:focus-within .save, #mmList .rowitem:focus-within .del,
#csModelsList .rowitem:focus-within .save, #csModelsList .rowitem:focus-within .del{
  display: inline-flex !important;
}

/* === Desktop fix: model row Save/Delete side-by-side (no stretching) ====== */
#manageCatalog #mmList .rowitem{
  display:grid !important;
  grid-template-columns: 1fr auto auto !important; /* input | Save | Delete */
  grid-auto-flow: column !important;
  align-items:center !important;
  gap:8px !important;
}
#manageCatalog #mmList .rowitem input{
  width: 100% !important;
  min-width: 0 !important;
}
#manageCatalog #mmList .rowitem .save,
#manageCatalog #mmList .rowitem .del{
  display:inline-flex !important;
  width:auto !important;
  max-width: fit-content !important;
  padding:8px 14px !important;
  border-radius:999px !important;
  white-space:nowrap !important;
  justify-self:end !important;
}

/* === Ensure Manage Product Types & Models modal is tall =================== */
#manageCatalog{
  top: 4vh !important;
  max-height: 92vh !important;
  min-height: 70vh !important;
}
#manageCatalog .content, #manageCatalog .list{
  max-height: 70vh !important;
  overflow: auto !important;
}

/* === Solid background for type dropdown options (all devices) ============ */
#manageCatalog .dropdown{
  background: #ffffff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 10px 24px rgba(2,6,23,.08) !important;
}
#manageCatalog .dropdown .dd-item{
  background: #ffffff !important;
  padding: 12px 14px !important;
  border-bottom: 1px solid #f1f5f9 !important;
}
#manageCatalog .dropdown .dd-item:hover{ background:#f8fafc !important; }

/* === Simple Catalog modal: taller + scrollable ============================ */
#catalogSimple{
  top: 4vh !important;
  max-height: 92vh !important;
  min-height: 70vh !important;
}
#catalogSimple .row,
#catalogSimple .list{
  /* make internal sections scroll independently when long */
  max-height: 70vh !important;
  overflow: auto !important;
}

/* === Solid background + taller list for options under the search bar ====== */
#catalogSimple .dd{
  background: #ffffff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 10px 24px rgba(2,6,23,.08) !important;
  max-height: 60vh !important;   /* show lots of choices; allow scrolling */
  overflow: auto !important;
}
#catalogSimple .dd .dd-item{
  background: #ffffff !important;
  padding: 12px 14px !important;
  border-bottom: 1px solid #f1f5f9 !important;
}
#catalogSimple .dd .dd-item:hover{ background:#f8fafc !important; }
</style>
<style>
/* === Fix: ensure dropdown visible (no clipping) ========================== */
#catalogSimple { overflow: auto !important; }  /* modal scrolls itself */
#catalogSimple .row{ 
  max-height: none !important; 
  overflow: visible !important;   /* don't clip absolute dropdown */
}
#catalogSimple .dd{
  position: absolute !important;
  z-index: 2000 !important;       /* above modal content */
}
#csTypeDD{ z-index: 2001 !important; }         /* specifically for type list */
</style><style>
/* === Adjust modal height to match list height ============================ */
#catalogSimple{
  height: auto !important;
  max-height: none !important;
}
#catalogSimple .dd{
  max-height: 320px !important; /* same as desired list height */
}
</style><style>
/* === Shrink modal to content: remove tall inner caps ===================== */
#catalogSimple .row,
#catalogSimple .list{
  max-height: unset !important;
  height: auto !important;
  overflow: visible !important;
}
#catalogSimple{
  height: auto !important;
  max-height: none !important;
  top: 8vh !important;           /* slight breathing room from top */
}
</style>
<style id="nrt-upgrade-20250816">
/* === User-requested mobile Saved Entries fix === */
@media (max-width: 640px){
  .saved-card{ flex-wrap: wrap !important; align-items: flex-start !important; }
  .saved-card > .spacer{ flex-basis: 100% !important; }
  /* Put Download below Edit/Delete (new line) */
  .saved-card .rec{ flex-basis: 100% !important; order: 3 !important; }
}

/* === User-requested field width match === */
/* Make Invoice Number and Grand Total inputs same min-width as Due */
#invoice, #grand{ min-width: 180px !important; }

</style>

<style id="nrt-upgrade-20250816b">
/* === Saved Entries: Button sizing & alignment === */
.saved-card {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.saved-card button {
  flex: 1 1 auto !important;
  min-width: unset !important;
}
.saved-card .rec {
  flex: 1 1 auto !important;
}

/* === Invoice Number same width as Number field === */
#invoice {
  width: 100% !important;
}

/* === Grand Total same width as Due field === */
#grand {
  width: 100% !important;
}

</style>

<style id="nrt-upgrade-20250816b">
/* === Saved Entries: Equal button sizes on one line === */
.saved-card {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.saved-card button {
  flex: 1 1 auto !important;
  min-width: unset !important;
}
.saved-card .rec {
  flex: 1 1 auto !important;
}

/* === Invoice Number matches Number field width === */
#invoice {
  width: 100% !important;
}

/* === Grand Total matches Due field width === */
#grand {
  width: 100% !important;
}

</style>

<style id="nrt-upgrade-20250816c">
/* === Saved Entries: keep 3 buttons on one line, equal size to each other === */
.saved-card{ display:flex !important; align-items:center !important; gap:10px !important; }
.saved-card .spacer{ flex:1 1 auto !important; }
.saved-card button{ flex:0 0 auto !important; }      /* auto width like standard buttons */
.saved-card .rec{ order:unset !important; flex:0 0 auto !important; }  /* undo previous full-width */

/* === Invoice Number same visual width as Number === */
#invoice{ width:100% !important; }  /* input stretches to column width */

/* === Grand Total same visual width as Due === */
#grand{ width:100% !important; }    /* input stretches to wrapper width */
</style>

</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="titlebar">
        <h1>N.R.T.</h1>
        <div class="muted">Record an Achievement</div>
      </div>

      <!-- Primary form fields -->
      <div class="section grid g2">
        <div>
          <label>Date *</label>
          <input type="date" id="date">
        </div>
        <div>
          <label>Invoice Number</label>
          <input id="invoice" readonly>
        </div>

        <div class="combo" style="grid-column:1 / -1;">
          <div class="row" style="justify-content:space-between; width:100%">
            <label>Name *</label>
            <button id="openManageContacts" class="icon-btn" title="Manage Contacts">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
              </svg>
            </button>
          </div>
          <input id="contactSearch" type="text" placeholder="Search or add contact...">
          <div id="contactDD" class="dropdown hidden"></div>
          <div id="inlineAddContact" class="hidden" style="margin-top:6px;">
            <span class="chip">Add "<span id="inlineName"></span>"
              <button id="inlineAddBtn" class="btn ghost" type="button" style="padding:4px 8px;margin-left:6px;">Open Manage</button>
            </span>
          </div>
        </div>

        <div>
          <label>Number</label>
          <input id="contactPhone" placeholder="Auto-filled from contact" readonly>
        </div>
        <div>
          <label>Address</label>
          <input id="contactAddress" placeholder="Auto-filled from contact" readonly>
        </div>
      </div>

      <!-- Line items -->
      <div class="section">
        <table>
          <thead>
            <tr>
              <th>Product Type <button id="openManageTypes" class="pill" type="button" title="Manage Product Types">✎</button></th>
              <th>Model <button id="openManageModels" class="pill" type="button" title="Manage Models">✎</button></th>
              <th class="right">Qty</th>
              <th class="right">Price (BDT)</th>
              <th class="right">Line Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
        <div class="row" style="margin-top:8px">
          <button id="addItem" class="btn warn" type="button">Add Item</button>
          <div class="spacer"></div>
          <div style="min-width:220px">
            <label>Due (optional)</label>
            <input id="due" type="number" step="1" min="0" value="0">
          </div>
          <div style="min-width:220px">
            <label>Grand Total</label>
            <input id="grand" readonly value="0.00">
          </div>
        </div>
      </div>

      <div class="footer">
        <label class="chip"><input type="checkbox" id="keepContact" style="margin-right:6px"> Keep contact after submit</label>
        <div class="spacer"></div>
        <button id="submit" class="btn primary" style="flex:1" type="button">Submit</button>
        <button id="clear" class="btn ghost" style="flex:1" type="button">Clear Form</button>
      </div>

      <!-- Manage Contacts -->
      <div class="section manage hidden" id="manageContacts" >
        <div class="row" style="justify-content:space-between; margin-bottom:6px">
          <strong>Manage Contacts</strong>
          <button id="closeManageContacts" class="btn gray" type="button">Close</button>
        </div>
        <div class="row" style="margin-bottom:10px">
          <input id="mcName" class="rowitem-input" placeholder="Store Name">
          <input id="mcPhone" class="rowitem-input" placeholder="01XXXXXXXXX or +88">
          <input id="mcAddr" class="rowitem-input" placeholder="Address">
          <button id="mcAdd" class="btn primary" type="button">Add</button>
        </div>
        <div class="list" id="mcList"></div>
      </div>

      
      <!-- Manage Catalog (Types + Models together) -->
      <div class="manage hidden" id="manageCatalog">
        <div class="row" style="justify-content:space-between; margin-bottom:6px">
          <strong>Manage Product Types &amp; Models</strong>
          <button id="closeManageCatalog" class="btn gray" type="button">Close</button>
        </div>
        <div class="grid g2">
          <!-- Manage Types (unchanged inner controls) -->
          <div class="section" id="manageTypes" style="background:transparent;border:0;padding:0">
            <div class="row" style="justify-content:space-between; margin-bottom:6px">
              <strong>Manage Product Types</strong>
              <button id="closeManageTypes" class="btn gray" type="button" style="display:none">Close</button>
            </div>
            <div class="row" style="margin-bottom:10px">
              <input id="mtSearch" class="rowitem-input" placeholder="Search or add type">
              <button id="mtAdd" class="btn primary" type="button">Add</button>
            </div>
            <div class="list" id="mtList"></div>
          </div>

          <!-- Manage Models (unchanged inner controls) -->
          <div class="section" id="manageModels" style="background:transparent;border:0;padding:0">
            <div class="row" style="justify-content:space-between; margin-bottom:6px">
              <strong>Manage Models</strong>
              <button id="closeManageModels" class="btn gray" type="button" style="display:none">Close</button>
            </div>
            <div class="row" style="margin-bottom:10px">
              <input id="mmSearch" class="rowitem-input" placeholder="Search or add model">
              <button id="mmAdd" class="btn primary" type="button">Add</button>
            </div>
            <div class="list" id="mmList"></div>
          </div>
        </div>
      </div>


      <!-- Simplified Catalog Popup (non-invasive) -->
      <div class="manage hidden" id="catalogSimple">
        <div class="row" style="justify-content:space-between; margin-bottom:6px">
          <strong>Manage Product Types &amp; Models</strong>
          <button id="csClose" class="btn gray" type="button">Close</button>
        </div>

        <!-- 2: Only a search bar -->
        <div class="row" style="gap:8px; margin-bottom:10px; position:relative">
          <input id="csSearch" class="rowitem-input" placeholder="Search or add product type">
          <button id="csTypeAdd" class="btn primary" type="button" style="display:none">Add</button>
          <div id="csTypeDD" class="dd hidden" style="max-height:220px; overflow:auto; position:absolute; top:48px; left:0; right:0; z-index:5"></div>
        </div>

        <!-- 6: Edit/Delete for selected product -->
        <div class="row hidden" id="csTypeActions" style="gap:8px; margin-bottom:10px">
          <button id="csTypeEdit" class="btn primary" type="button">Save</button>
          <button id="csTypeDelete" class="btn danger" type="button">Delete</button>
        </div>

        <!-- 7: Models for selected product -->
        <div class="hidden" id="csModelsWrap">
          <div class="row" style="justify-content:space-between; margin-bottom:6px">
            <strong id="csModelsTitle">Models</strong>
          </div>
          <div id="csModelsList" class="list"></div>
        </div>

        <!-- 9: Add model box (only after adding a new product) -->
        <div class="row hidden" id="csModelAddWrap" style="gap:8px; margin-top:10px">
          <input id="csModelInput" class="rowitem-input" placeholder="Add a model">
          <button id="csModelAdd" class="btn primary" type="button">Add Model</button>
        </div>
      </div>
<!-- Saved Entries -->
      <div class="section">
        <div class="row" style="justify-content:space-between; margin-bottom:6px">
          <strong>Saved Entries</strong>
          <div class="row">
            <input id="savedSearch" class="rowitem-input" placeholder="Search by name / phone / invoice / date" style="min-width:240px">
            <button id="clearFilters" class="btn gray" type="button">Clear Filters</button>
            <button id="viewDues" class="btn ghost" type="button">View Dues</button>
            <button id="dashboardBtn" class="btn ghost" type="button">Dashboard</button>
            <button id="exportCSV" class="btn warn" type="button">Export (.csv)</button>
          </div>
        </div>
        <div id="savedList" class="grid" style="gap:10px"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  // === Google Sheet Sync (rows) + Offline Queue ===
  const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcgu_yv_Tx09jrab6lPR-2Q1GSSQ_kOUZvCIsO6A0uGAx-QTmmNKPjtsxWW5vufHdB/exec';
  const OFFLINE_Q_KEY = 'nrt_offline_queue';

  function readQueue(){ try{ return JSON.parse(localStorage.getItem(OFFLINE_Q_KEY))||[]; }catch{ return []; } }
  function writeQueue(q){ localStorage.setItem(OFFLINE_Q_KEY, JSON.stringify(q)); }

  function rowsFromEntry(entry){
    const rows = [];
    (entry.items||[]).forEach(it => {
      const total = Number(it.qty||0) * Number(it.price||0);
      rows.push({
        Invoice: entry.invoice,
        Date: entry.date,
        Name: entry.store,
        Number: entry.phone || '',
        Address: entry.address || '',
        Product: it.type,
        Model: it.model,
        Quantity: Number(it.qty||0),
        Price: Number(it.price||0),
        Total: total,
        Due: Number(entry.due||0)
      });
    });
    return rows;
  }

  async function sendRows(rows){
    try {
      // Note: 'no-cors' returns an opaque response; we assume success if fetch resolves.
      await fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rows })
      });
      return true;
    } catch (e) {
      return false;
    }
  }

  
  // Storage Keys
  const K = {
    contacts: 'nrt_contacts',
    types: 'nrt_types',
    models: 'nrt_models', // { type: [models] }
    entries: 'nrt_entries_v2',
    invoiceSeq: 'nrt_invoice_seq'
  };

  // Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const read = (k, d) => { try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? d; } catch { return d; } };
  const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const pad5 = n => String(n).padStart(5, '0');
  const validBD = p => /^(?:\+?88)?01[3-9]\d{8}$/.test(String(p||'').trim());

  // State
  let contacts = read(K.contacts, []); // {name, phone, address}
  let types = read(K.types, ['Phone Charger','Ear Buds','USB Cable','Ear Phone']);
  let models = read(K.models, { 'Phone Charger':['20W','30W'], 'Ear Buds':['TWS-1'], 'USB Cable':['Type-C'], 'Ear Phone':['Wired'] });
  
  window.types = types; window.models = models;
let entries = read(K.entries, []);

  // Init invoice
  function nextInvoiceFromSeq(){
    let seq = Number(localStorage.getItem(K.invoiceSeq) || 0);
    return 'nrt-inv-' + pad5(seq+1);
  }
  function bumpInvoice(){
    let seq = Number(localStorage.getItem(K.invoiceSeq) || 0);
    localStorage.setItem(K.invoiceSeq, String(seq+1));
  }
  $('#invoice').value = nextInvoiceFromSeq();

  // Date default today
  function today(){
    const d=new Date();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  }
  $('#date').value = today();

  // Contact combobox
  const contactInput = $('#contactSearch');
  const contactDD = $('#contactDD');
  const inlineAdd = $('#inlineAddContact');
  const inlineName = $('#inlineName');

  function renderContactDD(list){
    contactDD.innerHTML = '';
    if(list.length===0){ contactDD.classList.add('hidden'); return; }
    list.forEach((c)=>{
      const div=document.createElement('div');
      div.className='dd-item';
      div.textContent = `${c.name} — ${c.phone||''}`.trim();
      div.onclick = ()=>{
        contactInput.value = c.name;
        $('#contactPhone').value = c.phone || '';
        $('#contactAddress').value = c.address || '';
        contactDD.classList.add('hidden');
        inlineAdd.classList.add('hidden');
      };
      contactDD.appendChild(div);
    });
    contactDD.classList.remove('hidden');
  }
  function contactMatches(q){
    q=q.toLowerCase();
    return contacts.filter(c => c.name.toLowerCase().includes(q) || (c.phone||'').includes(q) || (c.address||'').toLowerCase().includes(q));
  }
  function showAllContacts(){ renderContactDD(contacts); }

  contactInput.addEventListener('focus', showAllContacts);
  contactInput.addEventListener('click', showAllContacts);
  document.addEventListener('click', (e)=>{
    if(!contactDD.contains(e.target) && e.target!==contactInput){ contactDD.classList.add('hidden'); }
  });
  contactInput.addEventListener('input', ()=>{
    const q = contactInput.value.trim();
    renderContactDD(contactMatches(q));
    const exists = contacts.some(c => c.name.toLowerCase() === q.toLowerCase());
    if(q && !exists){ $('#inlineName').textContent = q; inlineAdd.classList.remove('hidden'); }
    else{ inlineAdd.classList.add('hidden'); }
  });
  $('#openManageContacts').onclick = ()=>{
    if(!mcOutsideHandler){
      mcOutsideHandler = (ev)=>{
        if (performance.now() - mcJustExpandedAt < 200) return;
        const mc = document.getElementById('manageContacts');
        if(!mc || mc.classList.contains('hidden')) return;
        const expanded = mc.querySelector('.rowitem.is-expanded');
        if(!expanded) return;
        if(expanded.contains(ev.target)) return;
        renderManageContacts('');
      };
      document.addEventListener('click', mcOutsideHandler);
    }
 document.body.classList.add('has-modal'); $('#manageContacts').classList.remove('hidden'); renderManageContacts(''); };
  $('#closeManageContacts').onclick = ()=>{
    if(mcOutsideHandler){
      document.removeEventListener('click', mcOutsideHandler);
      mcOutsideHandler = null;
    }
 $('#manageContacts').classList.add('hidden'); document.body.classList.remove('has-modal'); };
  $('#inlineAddBtn').onclick = ()=>{ $('#manageContacts').classList.remove('hidden'); $('#mcName').value = contactInput.value.trim(); renderManageContacts(''); inlineAdd.classList.add('hidden'); };

  // Items
  const body = $('#itemsBody');
  // Track last focused product type from items table to target Manage Models Add
  let lastFocusedType = '';
  $('#itemsBody').addEventListener('focusin', (e)=>{
    const tgt = e.target;
    if(tgt && (tgt.classList.contains('typeInput') || tgt.classList.contains('modelInput'))){
      const row = tgt.closest('tr');
      const ti = row ? row.querySelector('.typeInput') : null;
      lastFocusedType = ti ? (ti.value||'').trim() : lastFocusedType;
    }
  });
  function addRow(pref={}){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <div class="combo">
          <input class="typeInput" placeholder="Type">
          <button class="mini-pencil" type="button" title="Manage Product Types">✎</button>
          <div class="dropdown hidden"></div>
        </div>
      </td>
      <td>
        <div class="combo">
          <input class="modelInput" placeholder="Model">
          <button class="mini-pencil" type="button" title="Manage Models">✎</button>
          <div class="dropdown hidden"></div>
        </div>
      </td>
      <td class="right">
        <div class="qty">
          <button class="dec" type="button">−</button>
          <input class="qtyInput" type="text" inputmode="numeric" pattern="[0-9]*" value="${pref.qty||1}">
          <button class="inc" type="button">+</button>
        </div>
      </td>
      <td class="right"><input class="priceInput" type="number" step="0.01" min="0" value="${pref.price||0}"></td>
      <td class="right"><input class="lineTotal" readonly value="0.00"></td>
      <td class="right"><button class="btn danger del" type="button">Del</button></td>
    `;
    body.appendChild(tr);
    const typeI = tr.querySelector('.typeInput');
    const typeDD = tr.querySelectorAll('.dropdown')[0];
    const modelI = tr.querySelector('.modelInput');
    const modelDD = tr.querySelectorAll('.dropdown')[1];

    if(pref.type) typeI.value=pref.type;
    if(pref.model) modelI.value=pref.model;

    function renderTypeDD(q){
      q=(q||'').toLowerCase();
      const list = types.filter(t=>t.toLowerCase().includes(q)).map(t=>({label:t}));
      typeDD.innerHTML='';
      if(list.length===0){ typeDD.classList.add('hidden'); return; }
      list.forEach(it=>{
        const d=document.createElement('div'); d.className='dd-item'; d.textContent=it.label;
        d.onclick=()=>{ typeI.value=it.label; lastFocusedType = it.label; typeDD.classList.add('hidden'); modelI.value=''; renderModelDD(''); };
        typeDD.appendChild(d);
      });
      typeDD.classList.remove('hidden');
    }
    function renderModelDD(q){
      q=(q||'').toLowerCase();
      const ms = models[typeI.value] || [];
      const list = ms.filter(m=>m.toLowerCase().includes(q)).map(m=>({label:m}));
      modelDD.innerHTML='';
      if(list.length===0){ modelDD.classList.add('hidden'); return; }
      list.forEach(it=>{
        const d=document.createElement('div'); d.className='dd-item'; d.textContent=it.label;
        d.onclick=()=>{ modelI.value=it.label; modelDD.classList.add('hidden'); };
        modelDD.appendChild(d);
      });
      modelDD.classList.remove('hidden');
    }

    typeI.addEventListener('focus', ()=>renderTypeDD(''));
    typeI.addEventListener('click', ()=>renderTypeDD(typeI.value));
    typeI.addEventListener('input', ()=>renderTypeDD(typeI.value));

    modelI.addEventListener('focus', ()=>renderModelDD(''));
    modelI.addEventListener('click', ()=>renderModelDD(modelI.value));
    modelI.addEventListener('input', ()=>renderModelDD(modelI.value));

    tr.querySelector('.dec').onclick = ()=>{ const q=tr.querySelector('.qtyInput'); q.value=Math.max(1, (parseInt(q.value)||1)-1); recalcRow(tr); };
    tr.querySelector('.inc').onclick = ()=>{ const q=tr.querySelector('.qtyInput'); q.value=(parseInt(q.value)||1)+1; recalcRow(tr); };
    tr.querySelector('.qtyInput').addEventListener('input', ()=>recalcRow(tr));
    tr.querySelector('.priceInput').addEventListener('input', ()=>recalcRow(tr));
    tr.querySelector('.del').onclick = ()=>{ tr.remove(); recalcGrand(); };

    recalcRow(tr);
  }
  function recalcRow(tr){
    const q=Number(tr.querySelector('.qtyInput').value||0);
    const p=Number(tr.querySelector('.priceInput').value||0);
    tr.querySelector('.lineTotal').value = (q*p).toFixed(2);
    recalcGrand();
  }
  function recalcGrand(){
    let sum=0; $$('#itemsBody .lineTotal').forEach(x=> sum += Number(x.value||0));
    $('#grand').value = sum.toFixed(2);
  }
  $('#addItem').onclick = ()=> addRow();
  addRow();

  
  // Outside click handler for auto-shrink of expanded contact rows
  let mcOutsideHandler = null;
  let mcJustExpandedAt = 0;
// Manage Contacts
  
function renderManageContacts(filter=''){
    const list = $('#mcList'); list.innerHTML='';
    const q=(filter||'').toLowerCase();
    contacts
      .filter(c => !q 
          || (c.name||'').toLowerCase().includes(q) 
          || (c.phone||'').includes(q) 
          || (c.address||'').toLowerCase().includes(q))
      .forEach((c,i)=>{
        const row=document.createElement('div'); 
        row.className='rowitem';
        // Collapsed view: show only the number as a single line button
        const numberLabel = (c.phone && c.phone.trim()) ? c.phone : '(no number)';
        row.innerHTML = `<button class="btn gray expand" type="button" style="width:100%;justify-content:flex-start">${numberLabel}</button>`;
        row.classList.remove('is-expanded');

        const expand = () => {
          mcJustExpandedAt = performance.now();
          row.innerHTML = `
            <input value="${(c.name||'').replace(/"/g,'&quot;')}">
            <input value="${(c.phone||'').replace(/"/g,'&quot;')}">
            <input value="${(c.address||'').replace(/"/g,'&quot;')}">
            <button class="btn primary save" type="button">Save</button>
            <button class="btn danger del" type="button">Delete</button>`;
                    row.classList.add('is-expanded');
const [nm,ph,ad] = row.querySelectorAll('input');
          row.querySelector('.save').onclick = ()=>{
            const n=nm.value.trim(), p=ph.value.trim(), a=ad.value.trim();
            if(p && !validBD(p)){ alert('Phone must be a valid 11-digit Bangladeshi number'); return; }
            if(p && contacts.some((cc,j)=> j!==i && cc.phone===p)){ alert('This phone number already exists.'); return; }
            contacts[i]={name:n||'(no name)', phone:p||'', address:a||''};
            write(K.contacts, contacts);
            renderManageContacts(filter);
          };
          row.querySelector('.del').onclick = ()=>{
            if(!confirm('Delete this contact?')) return;
            contacts.splice(i,1); write(K.contacts, contacts); renderManageContacts(filter);
          };
        };
        row.querySelector('.expand').addEventListener('click', expand);
        list.appendChild(row);
      });
  }
  $('#mcName').addEventListener('input', ()=> renderManageContacts($('#mcName').value));
  $('#mcPhone').addEventListener('input', ()=> renderManageContacts($('#mcPhone').value));
  $('#mcAddr').addEventListener('input', ()=> renderManageContacts($('#mcAddr').value));
  $('#mcAdd').onclick = ()=>{
    const n=$('#mcName').value.trim();
    const p=$('#mcPhone').value.trim();
    const a=$('#mcAddr').value.trim();
    if(!n || !p || !a){ alert('Please fill Store Name, Phone and Address.'); return; }
    if(!validBD(p)){ alert('Phone must be a valid 11-digit Bangladeshi number'); return; }
    if(contacts.some(c=>c.phone===p)){ alert('This phone number already exists.'); return; }
    contacts.push({name:n, phone:p, address:a});
    write(K.contacts, contacts);
    renderManageContacts();
    $('#mcName').value=''; $('#mcPhone').value=''; $('#mcAddr').value='';
  };


  // Manage Types
  function renderTypesManage(filter=''){
    const list=$('#mtList'); list.innerHTML='';
    const q=(filter||'').toLowerCase();
    types.filter(t=>!q || t.toLowerCase().includes(q)).forEach((t,i)=>{
      const row=document.createElement('div'); row.className='rowitem';
      row.innerHTML=`<input value="${t}"><span></span><span></span>
        <button class="btn primary save" type="button">Save</button>
        <button class="btn danger del" type="button">Delete</button>`;
      const nm=row.querySelector('input');
      row.querySelector('.save').onclick=()=>{
        const v=nm.value.trim(); if(!v) return;
        if(types.map(x=>x.toLowerCase()).includes(v.toLowerCase()) && v.toLowerCase()!==t.toLowerCase()){ alert('Type exists'); return; }
        if(models[t] && !models[v]){ models[v]=models[t]; delete models[t]; }
        types[i]=v; write(K.types, types); write(K.models, models); renderTypesManage(filter);
      };
      row.querySelector('.del').onclick=()=>{ const del=types.splice(i,1)[0]; delete models[del]; write(K.types, types); write(K.models, models); renderTypesManage(filter); };
      list.appendChild(row);
    });
  }
  $('#mtSearch').addEventListener('input', ()=> renderTypesManage($('#mtSearch').value));
  $('#mtAdd').onclick = ()=>{
    const v=$('#mtSearch').value.trim(); if(!v) return;
    if(types.map(x=>x.toLowerCase()).includes(v.toLowerCase())){ alert('Type exists'); return; }
    types.push(v); models[v]=models[v]||[]; write(K.types, types); write(K.models, models); renderTypesManage();
    $('#mtSearch').value='';
  };

  // Manage Models
  function renderModelsManage(filter=''){
    const list=$('#mmList'); list.innerHTML='';
    const q=(filter||'').toLowerCase();
    Object.keys(models).sort().forEach(tp=>{
      const head=document.createElement('div'); head.style.fontWeight='700'; head.textContent=tp; head.style.margin='6px 0';
      list.appendChild(head);
      (models[tp]||[]).filter(m=>!q || m.toLowerCase().includes(q)).forEach((m,idx)=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML=`<input value="${m}"><span></span><span></span>
          <button class="btn primary save" type="button">Save</button>
          <button class="btn danger del" type="button">Delete</button>`;
        const nm=row.querySelector('input');
        row.querySelector('.save').onclick=()=>{
          const v=nm.value.trim(); if(!v) return;
          if(models[tp].map(x=>x.toLowerCase()).includes(v.toLowerCase()) && v.toLowerCase()!==m.toLowerCase()){ alert('Model exists'); return; }
          models[tp][idx]=v; write(K.models, models); renderModelsManage(filter);
        };
        row.querySelector('.del').onclick=()=>{ models[tp].splice(idx,1); write(K.models, models); renderModelsManage(filter); };
        list.appendChild(row);
      });
    });
  }

  
// Open/close manage panels (as modal)
  let mcatalogOutsideHandler = null;
  function openCatalog(){
    if(!mcatalogOutsideHandler){
      mcatalogOutsideHandler = (ev)=>{
        const cat = document.getElementById('manageCatalog');
        if(!cat || cat.classList.contains('hidden')) return;
        const focused = cat.querySelector('.rowitem:focus-within');
        if(!focused) return;
        if(focused.contains(ev.target)) return;
        // blur active input so :focus-within rules hide buttons
        if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
      };
      document.addEventListener('click', mcatalogOutsideHandler);
    }
 document.body.classList.add('has-modal'); $('#manageCatalog').classList.remove('hidden'); renderTypesManage(''); renderModelsManage(''); }
  function closeCatalog(){
    if(mcatalogOutsideHandler){
      document.removeEventListener('click', mcatalogOutsideHandler);
      mcatalogOutsideHandler = null;
    }
 $('#manageCatalog').classList.add('hidden'); document.body.classList.remove('has-modal'); }
  $('#openManageTypes').onclick = ()=>{ openCatalog(); };
  $('#closeManageTypes').onclick = ()=> closeCatalog();
  $('#openManageModels').onclick = ()=>{ 
    // preserve lastFocusedType detection for add model
    let tp = (lastFocusedType||'').trim();
    if(!tp){
      const active = document.activeElement;
      if(active && active.closest && active.closest('#itemsBody tr')){
        const ti = active.closest('#itemsBody tr').querySelector('.typeInput');
        if(ti && ti.value.trim()) tp = ti.value.trim();
      }
    }
    if(!tp){
      const filled=[...document.querySelectorAll('#itemsBody .typeInput')].map(i=>i.value.trim()).filter(Boolean);
      if(filled.length) tp = filled[filled.length-1];
    }
    lastFocusedType = tp;
    openCatalog();
  };
  $('#closeManageModels').onclick = ()=> closeCatalog();
  $('#closeManageCatalog').onclick = ()=> closeCatalog();
// Manage Models – search & add
  $('#mmSearch').addEventListener('input', ()=> renderModelsManage($('#mmSearch').value));
  $('#mmAdd').onclick = ()=>{
    const model = ($('#mmSearch').value||'').trim();
    if(!model) return;
    // Determine target product type
    let tp = (lastFocusedType||'').trim();
    if(!tp){
      const act=document.activeElement;
      if(act && act.closest && act.closest('#itemsBody tr')){
        const ti=act.closest('#itemsBody tr').querySelector('.typeInput');
        if(ti && ti.value.trim()) tp = ti.value.trim();
      }
    }
    if(!tp){
      const filled = Array.from(document.querySelectorAll('#itemsBody .typeInput')).map(i=>i.value.trim()).filter(Boolean);
      if(filled.length) tp = filled[filled.length-1];
    }
    if(!tp){ alert('Select a Product Type in the items table first.'); return; }
    // Canonicalize type to managed casing
    const canon = types.find(t => t.toLowerCase() === tp.toLowerCase()) || tp;
    tp = canon;
    models[tp] = models[tp] || [];
    if(models[tp].map(x=>x.toLowerCase()).includes(model.toLowerCase())){ alert('Model exists for this type'); return; }
    models[tp].push(model); write(K.models, models);
    renderModelsManage($('#mmSearch').value);
    $('#mmSearch').value = '';
  };

  

// ===== Simplified Catalog Popup (safe; no other logic changed) =====
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  let csSelected = ''; // currently selected product type

  function csReset(){
    csSelected = '';
    if($('#csSearch')) $('#csSearch').value = '';
    if($('#csTypeAdd')) $('#csTypeAdd').style.display = 'none';
    if($('#csTypeDD')) $('#csTypeDD').classList.add('hidden');
    if($('#csTypeActions')) $('#csTypeActions').classList.add('hidden');
    if($('#csModelsWrap')) $('#csModelsWrap').classList.add('hidden');
    if($('#csModelsList')) $('#csModelsList').innerHTML = '';
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.add('hidden');
  }

  let csOutsideHandler = null;
  function csOpen(){
    if(!csOutsideHandler){
      csOutsideHandler = (ev)=>{
        const cs = document.getElementById('catalogSimple');
        if(!cs || cs.classList.contains('hidden')) return;
        const focused = cs.querySelector('.rowitem:focus-within');
        if(!focused) return;
        if(focused.contains(ev.target)) return;
        if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
      };
      document.addEventListener('click', csOutsideHandler);
    }

    document.body.classList.add('has-modal');
    $('#catalogSimple').classList.remove('hidden');
    csReset();
  }
  function csClose(){
    if(csOutsideHandler){
      document.removeEventListener('click', csOutsideHandler);
      csOutsideHandler = null;
    }

    $('#catalogSimple').classList.add('hidden');
    document.body.classList.remove('has-modal');
  }

  // Hook pencil icons to open simplified popup
  if($('#openManageTypes'))  $('#openManageTypes').onclick  = csOpen;
  if($('#openManageModels')) $('#openManageModels').onclick = csOpen;
  if($('#csClose')) $('#csClose').onclick = csClose;

  // Delegate mini pencil clicks (mobile) to open the manager
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.classList && t.classList.contains('mini-pencil')){ csOpen(); }
  });


  // Show dropdown of existing products on focus/input
  function csRenderTypeDD(filter=''){
    const dd = $('#csTypeDD'); if(!dd) return;
    const q = (filter||'').toLowerCase();
    dd.innerHTML = '';
    const list = (window.types||[]).filter(t => !q || t.toLowerCase().includes(q));
    if(list.length === 0){ dd.classList.add('hidden'); return; }
    list.forEach(t=>{
      const item = document.createElement('div');
      item.className = 'dd-item';
      item.textContent = t;
      item.onclick = ()=> csSelectType(t);
      dd.appendChild(item);
    });
    dd.classList.remove('hidden');
  }

  function csSelectType(tp){
    csSelected = tp;
    if($('#csSearch')) $('#csSearch').value = tp;
    if($('#csTypeAdd')) $('#csTypeAdd').style.display = 'none';
    if($('#csTypeDD')) $('#csTypeDD').classList.add('hidden');
    // Show actions
    if($('#csTypeActions')) $('#csTypeActions').classList.remove('hidden');
    // Show models
    csRenderModels(tp);
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.remove('hidden');
  }

  function csRenderModels(tp){
    const wrap = $('#csModelsWrap'); const list = $('#csModelsList');
    if(!wrap || !list) return;
    list.innerHTML = '';
    const arr = (window.models||{})[tp] || [];
    arr.forEach((m, idx)=>{
      const row = document.createElement('div');
      row.className = 'rowitem';
      row.innerHTML = `<input value="${m}"><span></span><span></span>
        <button class="btn primary save" type="button">Save</button>
        <button class="btn danger del" type="button">Delete</button>`;
      const inp = row.querySelector('input');
      row.querySelector('.save').onclick = ()=>{
        const v = (inp.value||'').trim(); if(!v) return;
        const lower = arr.map(x=>x.toLowerCase());
        if(lower.includes(v.toLowerCase()) && v.toLowerCase()!==m.toLowerCase()){ alert('Model exists'); return; }
        arr[idx] = v; window.models[tp] = arr; localStorage.setItem('nrt_models', JSON.stringify(window.models)); csRenderModels(tp);
      };
      row.querySelector('.del').onclick = ()=>{
        arr.splice(idx,1); window.models[tp] = arr; localStorage.setItem('nrt_models', JSON.stringify(window.models)); csRenderModels(tp);
      };
      list.appendChild(row);
    });
    if($('#csModelsTitle')) $('#csModelsTitle').textContent = 'Models — ' + tp;
    wrap.classList.remove('hidden');
  }

  // Search bar behavior (4,8)
  if($('#csSearch')){
    $('#csSearch').addEventListener('focus', ()=> csRenderTypeDD($('#csSearch').value));
    $('#csSearch').addEventListener('input', ()=>{
      const v = ($('#csSearch').value||'').trim();
      const exists = (window.types||[]).map(x=>x.toLowerCase()).includes(v.toLowerCase());
      if($('#csTypeAdd')) $('#csTypeAdd').style.display = v && !exists ? 'inline-flex' : 'none';
      csRenderTypeDD(v);
    });
  }

  // 6: Save/Delete for product type
  if($('#csTypeEdit')) $('#csTypeEdit').onclick = ()=>{
    const current = csSelected; if(!current) return;
    const v = ($('#csSearch').value||'').trim(); if(!v) return;
    if(v.toLowerCase()!==current.toLowerCase()){
      const lower = (window.types||[]).map(x=>x.toLowerCase());
      if(lower.includes(v.toLowerCase())){ alert('Type exists'); return; }
      // rename
      const idx = (window.types||[]).findIndex(t=>t===current);
      if(idx>-1) window.types[idx] = v;
      if(window.models[current]){ if(!window.models[v]) window.models[v] = window.models[current]; delete window.models[current]; }
      localStorage.setItem('nrt_types', JSON.stringify(window.types));
      localStorage.setItem('nrt_models', JSON.stringify(window.models));
      csSelectType(v);
    }
  };
  if($('#csTypeDelete')) $('#csTypeDelete').onclick = ()=>{
    const current = csSelected; if(!current) return;
    if(!confirm('Delete product type and all its models?')) return;
    window.types = (window.types||[]).filter(t=>t!==current);
    delete window.models[current];
    localStorage.setItem('nrt_types', JSON.stringify(window.types));
    localStorage.setItem('nrt_models', JSON.stringify(window.models));
    csReset();
  };

  // 8–9: Add new product then show add model box
  if($('#csTypeAdd')) $('#csTypeAdd').onclick = ()=>{
    const v = ($('#csSearch').value||'').trim(); if(!v) return;
    const lower = (window.types||[]).map(x=>x.toLowerCase());
    if(lower.includes(v.toLowerCase())) return;
    window.types.push(v);
    /* keep existing ref */
    window.models[v] = window.models[v] || [];
    localStorage.setItem('nrt_types', JSON.stringify(window.types));
    localStorage.setItem('nrt_models', JSON.stringify(window.models));
    csSelected = v;
    if($('#csTypeActions')) $('#csTypeActions').classList.remove('hidden');
    if($('#csModelsWrap')) $('#csModelsWrap').classList.remove('hidden');
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.remove('hidden');
    if($('#csModelsTitle')) $('#csModelsTitle').textContent = 'Models — ' + v;
    csRenderModels(v);
  };

  if($('#csModelAdd')) $('#csModelAdd').onclick = ()=>{
    const tp = csSelected; if(!tp) return;
    const m = ($('#csModelInput').value||'').trim(); if(!m) return;
    window.models[tp] = window.models[tp] || [];
    const lower = window.models[tp].map(x=>x.toLowerCase());
    if(lower.includes(m.toLowerCase())){ alert('Model exists for this type'); return; }
    window.models[tp].push(m);
    localStorage.setItem('nrt_models', JSON.stringify(window.models));
    $('#csModelInput').value='';
    csRenderModels(tp);
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.remove('hidden');
  };
})();
// Saved entries rendering
  function renderSaved(filter=''){
    entries = read(K.entries, []);
    let list = entries.slice();
    if(filter){
      const q=filter.toLowerCase();
      list = list.filter(e => (e.store||'').toLowerCase().includes(q) || (e.phone||'').includes(q) || (e.invoice||'').toLowerCase().includes(q) || (e.date||'').toLowerCase().includes(q));
    }
    const wrap = $('#savedList'); wrap.innerHTML='';
    if(list.length===0){ const p=document.createElement('div'); p.className='muted'; p.textContent='No entries found.'; wrap.appendChild(p); return; }
    list.reverse().forEach((e)=>{
      const div=document.createElement('div'); div.className='saved-card';
      div.innerHTML=`
        <div class="spacer">
          <div><strong>${e.store}</strong> • ${e.phone||''}</div>
          <div class="meta">${e.date} • Invoice ${e.invoice} • Items: ${e.items.map(i=>`${i.type}/${i.model}×${i.qty}`).join(', ')} • Grand: BDT ${Number(e.grand).toFixed(2)} • Due: BDT ${Number(e.due||0).toFixed(2)}</div>
        </div>
        <button class="btn gray edit" type="button">Edit</button>
        <button class="btn danger del" type="button">Delete</button>
        <button class="btn primary rec" type="button">Download</button>`;
      // actions
      div.querySelector('.del').onclick=()=>{
        const pos = entries.findIndex(x=>x.invoice===e.invoice);
        if(pos>=0){ entries.splice(pos,1); write(K.entries, entries); renderSaved($('#savedSearch').value.trim()); }
      };
      div.querySelector('.edit').onclick=()=>{
        // load into form
        $('#date').value = e.date;
        $('#invoice').value = e.invoice; // keep invoice (editing)
        $('#contactSearch').value = e.store;
        $('#contactPhone').value = e.phone||'';
        $('#contactAddress').value = e.address||'';
        const body = $('#itemsBody'); body.innerHTML='';
        e.items.forEach(it=> addRow({type:it.type, model:it.model, qty:it.qty, price:it.price}));
        recalcGrand();
        $('#due').value = e.due||0;
        window.scrollTo({top:0,behavior:'smooth'});
      };
      div.querySelector('.rec').onclick=()=>{
        const w=window.open('','_blank');
        const itemsHtml = e.items.map(i=>`<tr><td>${i.type}</td><td>${i.model}</td><td class="r">${i.qty}</td><td class="r">BDT ${Number(i.price).toFixed(2)}</td><td class="r">BDT ${Number(i.total).toFixed(2)}</td></tr>`).join('');
        w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${e.invoice}</title>
        <style>body{font:14px system-ui;padding:24px} h2{margin:0 0 4px} .muted{color:#6b7280}
        table{width:100%;border-collapse:collapse;margin-top:16px} th,td{padding:8px;border-bottom:1px solid #e5e7eb} .r{text-align:right}
        .tot{margin-top:12px;text-align:right} .sig{margin-top:40px;text-align:center;color:#6b7280}</style>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
  <meta name="theme-color" content="#ffffff">
<style id="nrt-design-overrides">

/* === N.R.T. Design Overrides (Design-only) ===================================
   - Make all inputs consistent (incl. readonly: invoice, number, address, grand)
   - Make product row (qty/price/total) less bulky but finger-friendly
   - Keep system dark-mode support
============================================================================= */

:root{
  --inp-h: 50px;
  --inp-r: 12px;
  --inp-b: 1.5px;
  --border: #e5e7eb;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --accent: #3b82f6;
  --ring: rgba(59,130,246,.25);
  --soft: #f8fafc;
}

/* Dark mode tokens */
@media (prefers-color-scheme: dark){
  :root{
    --border: #334155;
    --surface: #0f172a;
    --text: #e5e7eb;
    --muted: #94a3b8;
    --soft: #0b1324;
    --ring: rgba(96,165,250,.35);
  }
}

/* Global input look */
body .wrap input[type="text"],
body .wrap input[type="number"],
body .wrap input[type="date"],
body .wrap select,
.section table td input {
  min-height: var(--inp-h) !important;
  font-size: 16px !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  box-shadow: none !important;
}

/* Readonly fields should look like normal inputs */
#invoice, #contactPhone, #contactAddress, #grand, #savedSearch,
body .wrap input[readonly]{
  background: var(--surface) !important;
  color: var(--text) !important;
  opacity: 1 !important;
  min-height: var(--inp-h) !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
}

/* Search inputs consistent */
#contactSearch{ min-height: var(--inp-h) !important; }

/* Product row — slimmer */
.section table tbody td{ padding-top: 8px !important; padding-bottom: 8px !important; }

/* Quantity group: compact but usable */
.qty{
  display:inline-flex; align-items:center; gap:8px;
  padding: 4px 6px !important;
  border: var(--inp-b) solid var(--border) !important;
  border-radius: 999px !important;
  background: var(--surface) !important;
}
.qty .qtyInput{
  width: 90px !important; height: 32px !important;
  border:0 !important; background:transparent !important;
  text-align:center !important; font-size:16px !important; padding:0 !important;
}
.qty .inc, .qty .dec{
  width: 28px !important; height: 28px !important; line-height: 24px !important;
  border-radius: 999px !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--soft) !important; font-size:18px !important; padding:0 !important;
  display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
}

/* Numeric fields align right */
.priceInput, .lineTotal, #due{ text-align:right !important; font-variant-numeric: tabular-nums; }
.priceInput, .lineTotal{ min-width: 120px !important; }
#due{ min-width: 180px !important; }

/* Focus ring */
body .wrap input[type="text"]:focus,
body .wrap input[type="number"]:focus,
body .wrap input[type="date"]:focus,
body .wrap select:focus {
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 3px var(--ring) !important;
  outline: none !important;
}

</style>

<style id="nrt-upgrade-20250816">
/* === User-requested mobile Saved Entries fix === */
@media (max-width: 640px){
  .saved-card{ flex-wrap: wrap !important; align-items: flex-start !important; }
  .saved-card > .spacer{ flex-basis: 100% !important; }
  /* Put Download below Edit/Delete (new line) */
  .saved-card .rec{ flex-basis: 100% !important; order: 3 !important; }
}

/* === User-requested field width match === */
/* Make Invoice Number and Grand Total inputs same min-width as Due */
#invoice, #grand{ min-width: 180px !important; }

</style>

<style id="nrt-upgrade-20250816b">
/* === Saved Entries: Button sizing & alignment === */
.saved-card {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.saved-card button {
  flex: 1 1 auto !important;
  min-width: unset !important;
}
.saved-card .rec {
  flex: 1 1 auto !important;
}

/* === Invoice Number same width as Number field === */
#invoice {
  width: 100% !important;
}

/* === Grand Total same width as Due field === */
#grand {
  width: 100% !important;
}

</style>

<style id="nrt-upgrade-20250816b">
/* === Saved Entries: Equal button sizes on one line === */
.saved-card {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.saved-card button {
  flex: 1 1 auto !important;
  min-width: unset !important;
}
.saved-card .rec {
  flex: 1 1 auto !important;
}

/* === Invoice Number matches Number field width === */
#invoice {
  width: 100% !important;
}

/* === Grand Total matches Due field width === */
#grand {
  width: 100% !important;
}

</style>

<style id="nrt-upgrade-20250816c">
/* === Saved Entries: keep 3 buttons on one line, equal size to each other === */
.saved-card{ display:flex !important; align-items:center !important; gap:10px !important; }
.saved-card .spacer{ flex:1 1 auto !important; }
.saved-card button{ flex:0 0 auto !important; }      /* auto width like standard buttons */
.saved-card .rec{ order:unset !important; flex:0 0 auto !important; }  /* undo previous full-width */

/* === Invoice Number same visual width as Number === */
#invoice{ width:100% !important; }  /* input stretches to column width */

/* === Grand Total same visual width as Due === */
#grand{ width:100% !important; }    /* input stretches to wrapper width */
</style>

</head>
        <body>
        <h2>ChinoMart BD</h2>
        <div class="muted">chinomartbd@gmail.com • Road 04, Shymoli, Sher-E-Bangla Nagar, Dhaka, Bangladesh</div>
        <p>Date: ${e.date}<br>Invoice: ${e.invoice}<br>Name: ${e.store}<br>Number: ${e.phone||''}<br>Address: ${e.address||''}</p>
        <table><thead><tr><th>Product</th><th>Model</th><th class="r">Qty</th><th class="r">Price</th><th class="r">Total</th></tr></thead>
        <tbody>${itemsHtml}</tbody></table>
        <div class="tot"><div><strong>Grand Total:</strong> BDT ${Number(e.grand).toFixed(2)}</div>
        <div><strong>Due:</strong> BDT ${Number(e.due||0).toFixed(2)}</div></div>
        <div class="sig">Signature</div>
        
</body></html>`);
        w.document.close(); w.focus(); w.print();
      };
      wrap.appendChild(div);
    });
  }
  renderSaved('');

  $('#savedSearch').addEventListener('input', ()=> renderSaved($('#savedSearch').value.trim()));
  $('#clearFilters').onclick = ()=>{ $('#savedSearch').value=''; renderSaved(''); };
  $('#viewDues').onclick = ()=>{
    const list = read(K.entries, []).filter(e=> Number(e.due||0) > 0 );
    const wrap=$('#savedList'); wrap.innerHTML='';
    if(list.length===0){ wrap.innerHTML='<div class="muted">No dues.</div>'; return; }
    list.forEach(e=>{
      const d=document.createElement('div'); d.className='saved-card'; d.innerHTML=`
        <div class="spacer"><strong>${e.store}</strong> — Invoice ${e.invoice}
        <div class="meta">${e.date} • Phone ${e.phone||''} • Due: BDT ${Number(e.due||0).toFixed(2)}</div></div>`;
      wrap.appendChild(d);
    });
  };

  $('#dashboardBtn').onclick = ()=>{ window.location.href = 'dashboard.html'; };


  // Export CSV
  
  $('#exportCSV').onclick = ()=>{
    // Export one row per item with all form fields in requested order
    const headers = ['Invoice','Date','Name','Number','Address','Product','Model','Quantity','Price','Total','Due'];
    const rows = [headers];
    const data = read(K.entries, []);
    data.forEach(e=>{
      const phoneText = e.phone ? ("'" + String(e.phone)) : '';
      (e.items||[]).forEach(i=>{
        const total = Number(i.qty||0) * Number(i.price||0);
        rows.push([e.invoice, e.date, e.store, phoneText, e.address||'', i.type, i.model, Number(i.qty||0), Number(i.price||0), total, Number(e.due||0)]);
      });
    });
    const esc = v => '"' + String(v).replace(/"/g,'""') + '"';
    const csv = rows.map(r => r.map(esc).join(',')).join('\r\n');
    const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='nrt_entries.csv'; a.click();
  };
;

  // Submit
  $('#submit').onclick = ()=>{
    const date=$('#date').value.trim();
    const invoice=$('#invoice').value.trim();
    const name=$('#contactSearch').value.trim();
    if(!date || !invoice || !name){ alert('Please fill date, invoice and shop name'); return; }
    const phone=$('#contactPhone').value.trim();
    const address=$('#contactAddress').value.trim();
    const keep = $('#keepContact').checked;

    const items=[];
    $$('#itemsBody tr').forEach(tr=>{
      const type=tr.querySelector('.typeInput').value.trim();
      const model=tr.querySelector('.modelInput').value.trim();
      // Validation: type & model must exist in managed lists
      const typeOk = types.includes(type);
      const modelsForType = models[type] || [];
      const modelOk = modelsForType.includes(model);
      if(!(typeOk && modelOk)){
        alert('Each item must use a Product Type and Model from Manage lists.');
        throw new Error('Invalid type/model');
      }
      const qty=Number(tr.querySelector('.qtyInput').value||0);
      const price=Number(tr.querySelector('.priceInput').value||0);
      if(type && model && qty>0){ items.push({type,model,qty,price,total:qty*price}); }
    });
    if(items.length===0){ alert('Please add at least one item'); return; }
    const grand=items.reduce((s,i)=>s+i.total,0);
    const due=Number($('#due').value||0);

    // Upsert contact by phone only (name/address can duplicate)
    if(phone && !validBD(phone)){ if(!confirm('Phone looks invalid. Continue without saving phone?')) return; }
    if(phone){
      const idx=contacts.findIndex(c=>c.phone===phone);
      if(idx>=0) contacts[idx]={name, phone, address}; else contacts.push({name, phone, address});
      write(K.contacts, contacts);
    } else {
      const idx=contacts.findIndex(c=>c.name.toLowerCase()===name.toLowerCase() && !c.phone);
      if(idx>=0) contacts[idx]={name, phone:'', address}; else contacts.push({name, phone:'', address});
      write(K.contacts, contacts);
    }

    // Save entry
    const entry={date, store:name, phone:phone||'', address, invoice, items, grand, due};
    const existingIdx = entries.findIndex(x=> x.invoice === invoice);
    const isEdit = existingIdx >= 0;
    if(isEdit){ entries[existingIdx] = entry; } else { entries.push(entry); }
    write(K.entries, entries);

    
    // === Send to Google Sheet (now or later) ===
    (async () => {
      const rows = rowsFromEntry(entry);
      if (navigator.onLine) {
        const ok = await sendRows(rows);
        if (!ok) { const q = readQueue(); q.push({rows}); writeQueue(q); }
      } else {
        const q = readQueue(); q.push({rows}); writeQueue(q);
      }
    })();
    
    
    // === Send to Google Sheet (flat JSON object) ===
    (async () => {
      const payload = {
        Invoice: newEntry.invoiceNumber || '',
        Date: newEntry.date || '',
        Name: newEntry.storeName || '',
        Number: newEntry.mobileNumber || '',
        Address: newEntry.address || '',
        Product: newEntry.gadgetType || '',
        Model: newEntry.modelName || '',
        Quantity: Number(newEntry.quantity || 0),
        Price: Number(newEntry.sellingPrice || 0),
        Total: Number(newEntry.totalRevenue || 0),
        Due: Number(newEntry.due || 0)
      };
      if (navigator.onLine) {
        try {
          await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          const q = JSON.parse(localStorage.getItem('nrt_offline_queue') || '[]');
          q.push(payload);
          localStorage.setItem('nrt_offline_queue', JSON.stringify(q));
        }
      } else {
        const q = JSON.parse(localStorage.getItem('nrt_offline_queue') || '[]');
        q.push(payload);
        localStorage.setItem('nrt_offline_queue', JSON.stringify(q));
      }
    })();
    alert(isEdit ? 'Updated' : 'Saved');

    renderSaved($('#savedSearch').value.trim());

    // bump invoice ONLY for new entries
    if(!isEdit){ bumpInvoice(); }
    $('#invoice').value = nextInvoiceFromSeq();
    $('#date').value=''; // clear date as requested
    $('#due').value='0';
    $('#grand').value='0.00';
    const body = $('#itemsBody'); body.innerHTML=''; addRow();
    if(!keep){ $('#contactSearch').value=''; $('#contactPhone').value=''; $('#contactAddress').value=''; }
  };

  // Clear Form (should not bump invoice; also clears date)
  $('#clear').onclick = ()=>{
    $('#date').value='';
    $('#invoice').value = nextInvoiceFromSeq();
    $('#due').value='0';
    $('#grand').value='0.00';
    const body = $('#itemsBody'); body.innerHTML=''; addRow();
    $('#contactSearch').value=''; $('#contactPhone').value=''; $('#contactAddress').value='';
  };

  // Initial renders (seed on first use for demo)
  function initialRender(){
    if(contacts.length===0){ contacts=[
      {name:'Hasan Tel', phone:'01711111111', address:'Mirpur 1'},
      {name:'Classic Mobile', phone:'01822222222', address:'Dhanmondi'},
      {name:'Adib', phone:'01933333333', address:'Shyamoli'},
    ]; write(K.contacts, contacts); }
    if(types.length===0){ types=['Phone Charger','Ear Buds','USB Cable','Ear Phone']; write(K.types, types); }
    if(Object.keys(models).length===0){ models={'Phone Charger':['20W','30W'],'Ear Buds':['TWS-1'],'USB Cable':['Type-C'],'Ear Phone':['Wired']}; write(K.models, models); }
    renderManageContacts('');
    renderTypesManage('');
    renderModelsManage('');
    renderSaved('');
  }
  initialRender();
})();

// === UI polish: Show Add buttons only for *new* entries + hide stale dropdowns ===
(function(){
  const ciIncludes = (arr, v) => arr.map(x=>String(x).toLowerCase()).includes(String(v||'').toLowerCase());

  // Types: toggle mtAdd
  const mtI = document.getElementById('mtSearch');
  const mtBtn = document.getElementById('mtAdd');
  function toggleMt(){
    if(!mtI || !mtBtn) return;
    const v = (mtI.value||'').trim();
    const isNew = v && !ciIncludes(types, v);
    mtBtn.style.display = isNew ? 'flex' : 'none';
  }
  if(mtI){
    mtI.addEventListener('input', toggleMt);
    toggleMt();
  }

  // Models: toggle mmAdd – treat as new if not found in ANY model list
  const mmI = document.getElementById('mmSearch');
  const mmBtn = document.getElementById('mmAdd');
  function allModelsFlat(){
    return Object.values(models).flat();
  }
  function toggleMm(){
    if(!mmI || !mmBtn) return;
    const v = (mmI.value||'').trim();
    const isNew = v && !ciIncludes(allModelsFlat(), v);
    mmBtn.style.display = isNew ? 'flex' : 'none';
  }
  if(mmI){
    mmI.addEventListener('input', toggleMm);
    toggleMm();
  }

  // When user clicks Add (type or model), hide any open dropdown menus so
  // stale suggestions from existing products don't linger.
  ['mtAdd','mmAdd','csTypeAdd'].forEach(id=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.dd').forEach(dd => dd.classList.add('hidden'));
      // re-evaluate visibility after add (inputs are usually cleared by original logic)
      setTimeout(()=>{ toggleMt(); toggleMm(); }, 0);
    });
  });

  // Also when opening the catalog modal, ensure buttons reflect current input
  const openOnce = setInterval(()=>{
    const el = document.getElementById('manageCatalog');
    if(el){ toggleMt(); toggleMm(); clearInterval(openOnce); }
  }, 200);
})();
// === End UI polish ===========================================================
</script>
<script>

// Ensure full-width Due & Grand wrappers on small screens (fallback for browsers without :has)
function fixDueGrandLayout(){
  try{
    ['due','grand'].forEach(id=>{
      const inp=document.getElementById(id);
      if(!inp) return;
      const wrap=inp.closest('div');
      if(!wrap) return;
      if(window.innerWidth<=820){
        wrap.style.minWidth='100%';
        wrap.style.flexBasis='100%';
        wrap.style.width='100%';
      }else{
        wrap.style.minWidth='';
        wrap.style.flexBasis='';
        wrap.style.width='';
      }
    });
  }catch(e){}
}
window.addEventListener('resize', fixDueGrandLayout);
document.addEventListener('DOMContentLoaded', fixDueGrandLayout);

</script>
</body>
</html>